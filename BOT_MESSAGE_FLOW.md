## Bot è¢« @ æ—¶çš„æ¶ˆæ¯æµç¨‹

### ğŸ“Š å®Œæ•´çš„æ•°æ®æµå‘å›¾

```
Discord é¢‘é“ä¸­çš„ç”¨æˆ·è¡Œä¸º
         â†“
    ç”¨æˆ·å¼•ç”¨æ¶ˆæ¯ + @ Bot + é™„è¨€
    ä¾‹å¦‚: "@Bot è¿™æ˜¯æ€çŒªç›˜"
         â†“
Discord API æ¥æ”¶åˆ°æ¶ˆæ¯
         â†“
    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
    â”‚  Bot Client (discord.py)             â”‚
    â”‚  æ¥æ”¶æ¶ˆæ¯äº‹ä»¶                        â”‚
    â”‚  on_message() äº‹ä»¶è§¦å‘              â”‚
    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
         â†“
    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
    â”‚  äº‹ä»¶å¤„ç†å±‚ (events.py)              â”‚
    â”‚  1. æ£€æŸ¥æ¶ˆæ¯æ˜¯å¦ @Bot               â”‚
    â”‚  2. éªŒè¯æ¶ˆæ¯æ ¼å¼ï¼ˆå¼•ç”¨æ¶ˆæ¯ï¼‰        â”‚
    â”‚  3. æå–å…³é”®ä¿¡æ¯                    â”‚
    â”‚     - ä¸¾æŠ¥äºº                       â”‚
    â”‚     - è¢«ä¸¾æŠ¥ç”¨æˆ·                   â”‚
    â”‚     - è¢«ä¸¾æŠ¥æ¶ˆæ¯å†…å®¹               â”‚
    â”‚     - ä¸¾æŠ¥é™„è¨€                     â”‚
    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
         â†“
    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
    â”‚  ä¸šåŠ¡é€»è¾‘å±‚ (moderation_service.py)  â”‚
    â”‚  1. è°ƒç”¨ Discord Service è·å–æ•°æ®    â”‚
    â”‚     - è¢«ä¸¾æŠ¥ç”¨æˆ·çš„è´¦æˆ·ä¿¡æ¯         â”‚
    â”‚     - ç”¨æˆ·æœ€è¿‘çš„å†å²æ¶ˆæ¯           â”‚
    â”‚     - é¢‘é“ä¿¡æ¯ç­‰                   â”‚
    â”‚  2. æ„å»º LLM åˆ†æè¯·æ±‚               â”‚
    â”‚  3. è°ƒç”¨ LLM Service               â”‚
    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
         â†“
    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
    â”‚  å¤–éƒ¨ API è°ƒç”¨                       â”‚
    â”‚  1. LLM Service è°ƒç”¨ OpenAI/ä¸­è½¬     â”‚
    â”‚  2. æ¥æ”¶åˆ†æç»“æœ                    â”‚
    â”‚     - BAN                          â”‚
    â”‚     - INVALID_REPORT               â”‚
    â”‚     - NEED_GM                      â”‚
    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
         â†“
    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
    â”‚  æ‰§è¡ŒåŠ¨ä½œ (Discord Service)          â”‚
    â”‚  æ ¹æ® LLM ç»“æœï¼š                     â”‚
    â”‚  â€¢ BAN: å°ç¦ + åˆ é™¤æ¶ˆæ¯ + å›å¤      â”‚
    â”‚  â€¢ INVALID: å›å¤"æœªå‘ç°è¿è§„"       â”‚
    â”‚  â€¢ NEED_GM: @GM è§’è‰² + é€šçŸ¥          â”‚
    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
         â†“
    Discord API æ‰§è¡Œæ“ä½œ + å‘é€å›å¤
         â†“
    ç”¨æˆ·çœ‹åˆ° Bot çš„å›å¤ä¸å¯¹åº”çš„åŠ¨ä½œ
```

---

## ğŸ”Œ Discord.py äº‹ä»¶æ¨é€æœºåˆ¶

### 1. **Bot æ¥æ”¶æ¶ˆæ¯äº‹ä»¶**

```python
# åœ¨ bot/client.py æˆ– events.py ä¸­
@bot.event
async def on_message(message):
    """
    Discord æ¨é€æ¶ˆæ¯äº‹ä»¶æ—¶è°ƒç”¨
    è¿™æ˜¯æœ€åŸºç¡€çš„äº‹ä»¶å¤„ç†
    """
    # æ£€æŸ¥æ˜¯å¦æ˜¯ Bot è‡ªå·±çš„æ¶ˆæ¯ï¼ˆé¿å…è‡ªå·±å›å¤è‡ªå·±ï¼‰
    if message.author == bot.user:
        return
    
    # æ£€æŸ¥æ¶ˆæ¯æ˜¯å¦ @Bot
    if bot.user in message.mentions:
        # å¤„ç†é€»è¾‘
        await handle_bot_mention(message)
```

### 2. **discord.py çš„äº‹ä»¶æ¨é€åŸç†**

```
Discord WebSocket è¿æ¥
    â†“
æ¥æ”¶äº‹ä»¶ JSONï¼ˆå¦‚ MESSAGE_CREATEï¼‰
    â†“
discord.py è§£æ JSON
    â†“
åˆ›å»º Message å¯¹è±¡
    â†“
è°ƒç”¨æ³¨å†Œçš„ @bot.event å‡½æ•°
    â†“
ä½ çš„ä»£ç æ‰§è¡Œ
```

**å…³é”®ç‚¹ï¼š**
- discord.py ä½¿ç”¨ WebSocket é•¿è¿æ¥æ¥æ”¶äº‹ä»¶
- æ‰€æœ‰äº‹ä»¶éƒ½æ˜¯**å¼‚æ­¥çš„**ï¼ˆasync/awaitï¼‰
- äº‹ä»¶æ¨é€**è‡ªåŠ¨ä¸”å®æ—¶**ï¼Œæ— éœ€è½®è¯¢

---

## ğŸ¯ å…·ä½“å®ç°æµç¨‹

### ç¬¬ä¸€æ­¥ï¼šæ¥æ”¶æ¶ˆæ¯äº‹ä»¶ï¼ˆdiscord.py è‡ªåŠ¨å¤„ç†ï¼‰

```python
# src/bot/client.py ä¸­æ·»åŠ äº‹ä»¶å¤„ç†å™¨
@bot.event
async def on_message(message: discord.Message):
    """Called when a message is sent in any channel the bot can see."""
    
    # 1. å¿½ç•¥ Bot è‡ªå·±çš„æ¶ˆæ¯
    if message.author == bot.user:
        return
    
    # 2. æ£€æŸ¥ Bot æ˜¯å¦è¢« @
    if bot.user not in message.mentions:
        return
    
    # 3. æ£€æŸ¥æ˜¯å¦æ˜¯å¼•ç”¨æ¶ˆæ¯ï¼ˆå›å¤æ¶ˆæ¯ï¼‰
    if message.reference is None:
        await message.reply("è¯·é€šè¿‡å¼•ç”¨æ¶ˆæ¯æ¥ä¸¾æŠ¥ï¼Œä¾‹å¦‚ï¼š\n`@Bot è¿™æ˜¯æ€çŒªç›˜`")
        return
    
    # 4. è·å–è¢«å¼•ç”¨çš„åŸå§‹æ¶ˆæ¯
    try:
        referenced_message = await message.channel.fetch_message(
            message.reference.message_id
        )
    except discord.NotFound:
        await message.reply("æ— æ³•æ‰¾åˆ°è¢«å¼•ç”¨çš„æ¶ˆæ¯")
        return
    
    # 5. å‡†å¤‡ä¸¾æŠ¥ä¿¡æ¯
    report_info = {
        "reporter": message.author,           # ä¸¾æŠ¥äºº
        "reported_user": referenced_message.author,  # è¢«ä¸¾æŠ¥ç”¨æˆ·
        "reported_message": referenced_message,      # è¢«ä¸¾æŠ¥æ¶ˆæ¯
        "reason": message.content,            # ä¸¾æŠ¥é™„è¨€
        "channel": message.channel,
        "guild": message.guild,
    }
    
    # 6. æ¨é€ç»™åç«¯å¤„ç†
    await handle_report(report_info)
```

### ç¬¬äºŒæ­¥ï¼šåç«¯å¤„ç†ä¸¾æŠ¥ï¼ˆä¸šåŠ¡é€»è¾‘å±‚ï¼‰

```python
# src/services/moderation_service.py
async def handle_report(report_info: dict):
    """å¤„ç†ç”¨æˆ·ä¸¾æŠ¥"""
    
    # 1. æ”¶é›†è¢«ä¸¾æŠ¥ç”¨æˆ·çš„ä¿¡æ¯
    user_info = await discord_service.get_user_info(
        report_info["reported_user"]
    )
    
    # 2. è·å–ç”¨æˆ·æœ€è¿‘çš„æ¶ˆæ¯å†å²
    user_history = await discord_service.get_user_message_history(
        report_info["channel"],
        report_info["reported_user"],
        limit=10
    )
    
    # 3. æ„å»º LLM åˆ†æè¯·æ±‚
    analysis_prompt = build_analysis_prompt(
        reported_message=report_info["reported_message"],
        user_history=user_history,
        user_info=user_info,
        report_reason=report_info["reason"]
    )
    
    # 4. è°ƒç”¨ LLM è¿›è¡Œåˆ†æ
    result = await llm_service.analyze_message(analysis_prompt)
    
    # 5. æ ¹æ®ç»“æœæ‰§è¡Œå¯¹åº”åŠ¨ä½œ
    if result == "BAN":
        await execute_ban(report_info)
    elif result == "INVALID_REPORT":
        await execute_invalid(report_info)
    elif result == "NEED_GM":
        await escalate_to_gm(report_info)
```

### ç¬¬ä¸‰æ­¥ï¼šæ‰§è¡ŒåŠ¨ä½œï¼ˆDiscord API è°ƒç”¨ï¼‰

```python
# src/services/discord_service.py
async def execute_ban(report_info):
    """å°ç¦ç”¨æˆ·"""
    
    user_to_ban = report_info["reported_user"]
    guild = report_info["guild"]
    channel = report_info["channel"]
    
    # 1. åˆ é™¤è¯¥ç”¨æˆ· 7 å¤©å†…çš„æ¶ˆæ¯
    async for message in channel.history(limit=None):
        if message.author == user_to_ban:
            if (datetime.utcnow() - message.created_at).days <= 7:
                await message.delete()
    
    # 2. å°ç¦ç”¨æˆ·
    await guild.ban(
        user_to_ban,
        reason="LLM Guard Bot è‡ªåŠ¨å°ç¦"
    )
    
    # 3. å‘ä¸¾æŠ¥äººå›å¤
    await channel.send(
        f"{report_info['reporter'].mention} "
        f"å·²å¤„ç†è¯¥ä¸¾æŠ¥ï¼Œç”¨æˆ·å·²è¢«å°ç¦"
    )
```

---

## ğŸ”‘ å…³é”®æŠ€æœ¯ç‚¹

### 1. **äº‹ä»¶è§¦å‘æœºåˆ¶**

| äº‹ä»¶ | ä½•æ—¶è§¦å‘ | ç”¨é€” |
|-----|--------|------|
| `on_message()` | æ”¶åˆ°æ–°æ¶ˆæ¯ | æ£€æµ‹ @Bot |
| `on_ready()` | Bot è¿æ¥æˆåŠŸ | åˆå§‹åŒ– |
| `on_member_join()` | ç”¨æˆ·åŠ å…¥æœåŠ¡å™¨ | å¯ç”¨äºå®¡æ ¸æ–°æˆå‘˜ |
| `on_member_remove()` | ç”¨æˆ·ç¦»å¼€æœåŠ¡å™¨ | æ¸…ç†æ•°æ® |

### 2. **å¼‚æ­¥éé˜»å¡**

æ‰€æœ‰æ“ä½œéƒ½æ˜¯**å¼‚æ­¥çš„**ï¼ŒBot å¯ä»¥åŒæ—¶å¤„ç†å¤šä¸ªç”¨æˆ·çš„ä¸¾æŠ¥ï¼š

```python
# âœ… æ­£ç¡®çš„å¼‚æ­¥å¤„ç†
async def on_message(message):
    await asyncio.gather(
        handle_report_1(),
        handle_report_2(),
        handle_report_3(),
        # ... å¯ä»¥åŒæ—¶å¤„ç†å¤šä¸ªä»»åŠ¡
    )
```

### 3. **æ¶ˆæ¯å¯¹è±¡ç»“æ„**

```python
message.author          # å‘é€äºº
message.content         # æ¶ˆæ¯æ–‡æœ¬
message.mentions        # @çš„ç”¨æˆ·åˆ—è¡¨
message.reference       # å¼•ç”¨ä¿¡æ¯ï¼ˆå¦‚æœæ˜¯å›å¤ï¼‰
message.channel         # é¢‘é“å¯¹è±¡
message.guild           # æœåŠ¡å™¨å¯¹è±¡
message.created_at      # åˆ›å»ºæ—¶é—´
```

---

## ğŸ“ˆ æ€§èƒ½ä¸å¯æ‰©å±•æ€§

### æ¨é€æœºåˆ¶çš„ä¼˜åŠ¿

âœ… **å®æ—¶æ€§**ï¼šWebSocket é•¿è¿æ¥ï¼Œæ¯«ç§’çº§å“åº”  
âœ… **æ•ˆç‡**ï¼šä¸éœ€è¦è½®è¯¢ API  
âœ… **å¯æ‰©å±•**ï¼šdiscord.py å¯ä»¥å¤„ç†æ•°åƒä¸ªå¹¶å‘æ¶ˆæ¯  
âœ… **è‡ªåŠ¨é‡è¿**ï¼šDiscord è¿æ¥æ–­å¼€æ—¶è‡ªåŠ¨é‡æ–°è¿æ¥  

### ç¤ºä¾‹ï¼šå¹¶å‘å¤„ç†å¤šä¸ªä¸¾æŠ¥

```python
# discord.py è‡ªåŠ¨ä¸ºæ¯æ¡æ¶ˆæ¯åˆ›å»ºç‹¬ç«‹çš„ä»»åŠ¡
# 5 ä¸ªç”¨æˆ·åŒæ—¶ @ Botï¼Œ5 ä¸ª on_message() ä¼šå¹¶å‘æ‰§è¡Œ

@bot.event
async def on_message(message):
    # æ¯ä¸ªæ¶ˆæ¯éƒ½ä¼šè§¦å‘è¿™ä¸ªå‡½æ•°
    # discord.py å†…éƒ¨ä½¿ç”¨ asyncio ç®¡ç†å¹¶å‘
    await handle_report(message)
    # å¤„ç†ä¸ä¼šé˜»å¡å…¶ä»–æ¶ˆæ¯çš„å¤„ç†
```

---

## ğŸš€ æ€»ç»“

**Bot è¢« @ æ—¶çš„æ¨é€æµç¨‹ï¼š**

1. ç”¨æˆ·åœ¨ Discord å‘é€æ¶ˆæ¯å¹¶ @Bot
2. Discord æœåŠ¡å™¨é€šè¿‡ WebSocket æ¨é€äº‹ä»¶ç»™ Bot
3. discord.py è§£æäº‹ä»¶å¹¶è°ƒç”¨ `on_message()` å‡½æ•°
4. ä½ çš„ä»£ç æ£€æŸ¥æ˜¯å¦æ˜¯æœ‰æ•ˆçš„ä¸¾æŠ¥è¯·æ±‚
5. è°ƒç”¨åç«¯æœåŠ¡è¿›è¡Œåˆ†æ
6. æ‰§è¡Œå¯¹åº”çš„åŠ¨ä½œï¼ˆå°ç¦/é©³å›/é€šçŸ¥ GMï¼‰
7. ç”¨æˆ·çœ‹åˆ° Bot çš„å›å¤å’Œå¯¹åº”åŠ¨ä½œ

**å…³é”®ç‰¹ç‚¹ï¼š**
- âœ… å®æ—¶æ¨é€ï¼Œæ— éœ€è½®è¯¢
- âœ… å¼‚æ­¥å¤„ç†ï¼Œå¯å¹¶å‘å¤„ç†å¤šä¸ªä¸¾æŠ¥
- âœ… å®Œå…¨ç”± discord.py åº“è‡ªåŠ¨ç®¡ç†
- âœ… å¼€å‘è€…åªéœ€å®ç°ä¸šåŠ¡é€»è¾‘




